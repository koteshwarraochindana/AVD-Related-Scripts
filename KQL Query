let daysAgo = 31d;

// Connection summary
let connectionSummary = 
    WVDConnections
    | where TimeGenerated > ago(daysAgo)
    | extend ConnectionType = case(
        TransportType == "Reverse Connect" or TransportType == "TCP", "TCP",
        TransportType == "Shortpath" or TransportType == "UDP", "UDP",
        TransportType == "RDP", "RDP",
        isnull(TransportType) or TransportType == "", "Unknown",
        "Other"
    )
    | summarize NumberOfConnections = count(), 
                ConnectionTypes = make_set(ConnectionType), 
                SessionHosts = make_set(SessionHostName) 
        by UserName, ClientIPAddress
    | extend ip_location = parse_json(ip_location_from_ip_address(ClientIPAddress))
    | extend Country = tostring(ip_location.country), 
             City = tostring(ip_location.city);

// Error summary
let errorSummary = 
    WVDErrors
    | where TimeGenerated > ago(daysAgo)
    | summarize ErrorCount = count(), 
                ErrorCodes = make_set(CodeSymbolic) 
        by UserName;

// Duration summary
let durationSummary = 
    WVDConnections
    | where TimeGenerated > ago(daysAgo)
    | where State == "Connected"
    | project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated
    | join kind=leftouter (
        WVDConnections
        | where State == "Completed"
        | project EndTime = TimeGenerated, CorrelationId
    ) on CorrelationId
    | extend SessionDuration = EndTime - StartTime
    | summarize TotalDuration = sum(SessionDuration) by UserName, ConnectionType
    | extend DurationHours = round(TotalDuration / 1h, 2), 
             DurationDays = round(DurationHours / 24, 2);

// Final query that starts after all let blocks
connectionSummary
| join kind=leftouter errorSummary on UserName
| join kind=leftouter durationSummary on UserName
| project UserName, 
          SessionHosts, 
          NumberOfConnections, 
          ClientIPAddress, 
          ConnectionTypes, 
          Country, 
          State, 
          City, 
          ErrorCount, 
          ErrorCodes, 
          DurationHours, 
          DurationDays
| order by NumberOfConnections desc

---------------------------------------------

let connectionSummary =
    WVDConnections
    | where TimeGenerated > ago(31d)
    | summarize NumberOfConnections = count() by UserName, ClientIPAddress;

connectionSummary
| take 5
---------------------------------------

let disk_free_space_percent =
    Perf
    | where TimeGenerated > ago(5m)
    | where Computer contains "avd"
    | where ObjectName == "LogicalDisk"
    | where CounterName == "% Free Space"
    | where InstanceName contains "C:"
    | summarize Disc_Space_Percent = (100 - avg(CounterValue)) by Computer, InstanceName
    | where strlen(InstanceName) == 2 and InstanceName contains ":"
    | where Disc_Space_Percent > 90;

let disk_free_MB =
    Perf
    | where TimeGenerated > ago(5m)
    | where ObjectName == "LogicalDisk"
    | where CounterName == "Free Megabytes"
    | summarize (TimeGenerated, Free_MB) = arg_max(TimeGenerated, CounterValue) by Computer, InstanceName
    | where strlen(InstanceName) == 2 and InstanceName contains ":";

disk_free_space_percent
| join kind=inner (disk_free_MB) on Computer, InstanceName
| project Computer, InstanceName, Disc_Space_Percent, Free_MB
| order by Disc_Space_Percent desc

---------------------------------------------------------------

// 1. Percentage of free space (% Free Space)
let disk_free_space_percent =
    Perf
    | where TimeGenerated > ago(5m)
    | where Computer startswith "pavw4"
    | where ObjectName == "LogicalDisk"           // update if your workspace uses: "Logical Disk"
    | where CounterName == "% Free Space"         // update if workspace uses: "Free Space %"
    | where InstanceName contains "C"             // update if workspace uses "C:"
    | summarize Disc_Space_Percent = (100 - avg(CounterValue))
        by Computer, InstanceName
    | where Disc_Space_Percent > 90;

// 2. Free Megabytes (to show actual GB remaining)
let disk_free_MB =
    Perf
    | where TimeGenerated > ago(5m)
    | where Computer startswith "pavw4"
    | where ObjectName == "LogicalDisk"           
    | where CounterName == "Free Megabytes"
    | summarize (TimeGenerated, Free_MB) = arg_max(TimeGenerated, CounterValue)
        by Computer, InstanceName;

// 3. Join both datasets
disk_free_space_percent
| join kind=inner disk_free_MB on Computer, InstanceName
| project Computer,
          Drive = InstanceName,
          Disc_Space_Percent,
          Free_MB,
          Free_GB = round(Free_MB / 1024.0, 2)
| order by Disc_Space_Percent desc

----------------------------------------------------------------

$urls = @(
"global.wvd.microsoft.com",
"rdweb.wvd.microsoft.com",
"ncus.rdbroker.wvd.microsoft.com",
"ncus.gcs.wvd.microsoft.com",
"scus.rdbroker.wvd.microsoft.com",
"scus.gcs.wvd.microsoft.com"
)

while ($true) {
    foreach ($url in $urls) {
        $r = Test-NetConnection $url -Port 443
        Write-Host "$($url) : $($r.TcpTestSucceeded)" -ForegroundColor Yellow
    }
    Start-Sleep 5
}


