# ============================================================
# AVD Workspace → HostPool → VM Assignment Report
# Multi-Subscription Version
# ============================================================

# ----------------------------
# LOGIN
# ----------------------------
Connect-AzAccount

# ----------------------------
# SUBSCRIPTIONS TO REPORT
# ----------------------------
$SubscriptionIds = @(
    "a1b2c3d4-5678-90ab-cdef-111213141516",  # Subscription 1
    "b2c3d4e5-6789-01bc-def2-222324252627"   # Subscription 2
)

# ----------------------------
# MAIN REPORT ARRAY
# ----------------------------
$finalReport = @()

foreach ($SubscriptionId in $SubscriptionIds) {

    Write-Host "`nProcessing subscription: $SubscriptionId ..." -ForegroundColor Cyan

    # Set the context to this subscription
    Set-AzContext -SubscriptionId $SubscriptionId

    # Safety check
    if ((Get-AzContext).Subscription.Id -ne $SubscriptionId) {
        Write-Warning "Failed to switch context to $SubscriptionId. Skipping..."
        continue
    }

    # Get all Workspaces in this subscription
    $workspaces = Get-AzWvdWorkspace

    foreach ($ws in $workspaces) {

        foreach ($agRef in $ws.ApplicationGroupReference) {

            # Get Application Group
            $ag = Get-AzWvdApplicationGroup -ResourceId $agRef

            # Extract Host Pool info from ARM path
            $hpIdParts = $ag.HostPoolArmPath -split "/"
            $hpRG   = $hpIdParts[$hpIdParts.IndexOf("resourceGroups") + 1]
            $hpName = $hpIdParts[-1]

            # Get Host Pool
            $hp = Get-AzWvdHostPool -ResourceGroupName $hpRG -Name $hpName

            # Get Session Hosts
            $sessionHosts = Get-AzWvdSessionHost -ResourceGroupName $hpRG -HostPoolName $hpName

            # Assignment counts (Personal desktops)
            $assignedVMs   = $sessionHosts | Where-Object { $_.AssignedUser }
            $unassignedVMs = $sessionHosts | Where-Object { -not $_.AssignedUser }

            # Add to final report
            $finalReport += [PSCustomObject]@{
                SubscriptionId    = $SubscriptionId
                WorkspaceName     = $ws.Name
                WorkspaceRG       = $ws.ResourceGroupName
                ApplicationGroup  = $ag.Name
                HostPoolName      = $hpName
                HostPoolType      = $hp.HostPoolType
                TotalVMs          = $sessionHosts.Count
                AssignedVMs       = $assignedVMs.Count
                UnassignedVMs     = $unassignedVMs.Count
            }
        }
    }
}

# ----------------------------
# DISPLAY REPORT
# ----------------------------
$finalReport | Sort-Object SubscriptionId, WorkspaceName, HostPoolName | Format-Table -AutoSize

# ----------------------------
# OPTIONAL: EXPORT TO CSV
# ----------------------------
$csvFile = "AVD-MultiSubscription-Report.csv"
$finalReport | Export-Csv $csvFile -NoTypeInformation
Write-Host "`nReport exported to $csvFile" -ForegroundColor Green


--------------------------------------------------------------------

# Install main Azure module
Install-Module -Name Az -Force

# Install AVD (Desktop Virtualization) module
Install-Module -Name Az.DesktopVirtualization -Force
-----------------------------------------------------------------------
Get-Module -ListAvailable | Where-Object {$_.Name -like "Az*"}
----------------------------------
Register-PSRepository -Name PSGallery -SourceLocation https://www.powershellgallery.com/api/v2 -InstallationPolicy Trusted

--------------------------------------------------------------------------------------------


WVDConnections
| where TimeGenerated > ago(1d)
| extend SessionDurationHours = datetime_diff("hour", TimeGenerated, now())
| where SessionDurationHours >= 8
| where State in ("Active", "Disconnected")
| project
    TimeGenerated,
    UserName,
    SessionHostName,
    State,
    SessionDurationHours
| order by SessionDurationHours desc

------------------------------------------------

WVDConnections
| extend EndTimeFixed = iff(isnull(EndTime), now(), EndTime)
| extend SessionDurationHours = datetime_diff("hour", StartTime, EndTimeFixed)
| where SessionDurationHours >= 8
| where State in ("Active", "Disconnected")
| project
    UserName,
    SessionHostName,
    State,
    StartTime,
    EndTimeFixed,
    SessionDurationHours
| order by SessionDurationHours desc

--------------------------------------------

WVDSessions
| where SessionState in ("Active", "Disconnected")
| extend SessionDurationHours = datetime_diff("hour", StartTime, now())
| where SessionDurationHours >= 8
| project
    UserPrincipalName,
    SessionHostName,
    SessionState,
    StartTime,
    SessionDurationHours
| order by SessionDurationHours desc

-------------------------------------------------

WVDConnections
| extend SessionDurationHours = datetime_diff("hour", StartTime, now())
| where SessionDurationHours >= 8
| where State in ("Active", "Disconnected")
| summarize LongRunningSessions = count() by SessionHostName
| order by LongRunningSessions desc

------------------------------------------------------------


